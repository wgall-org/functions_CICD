name: Create Cloud function 

on:
  workflow_call:
env:
  tag: ${GITHUB_REF#refs/*/}
  repository: wgall-org/functions_CICD

jobs:        
  create_function:
      name: Deploy function on Cloud 
      runs-on: ubuntu-latest
      steps:
        - name: Correct project name
          run: echo "reponame=$(echo ${{ github.event.repository.name }} | tr _ - )" >> $GITHUB_ENV
        - name: Checkout code repository
          uses: actions/checkout@v3
        - name: Authenitcate pipeline repository 
          uses: 'google-github-actions/auth@v1'
          with:
            credentials_json: ${{ secrets.SA_CREDENTIALS }}
        - name: Setup pipline repository
          uses: google-github-actions/setup-gcloud@main 
          with:
            project_id: ${{ env.projectid }}
            export_default_credentials: true
        - id: 'deploy'
          uses: 'google-github-actions/deploy-cloud-functions@v1'
          with:
            name: "${{env.reponame}}-${{ env.tag }}"
            runtime: 'nodejs16' 
            entry_point: main
            region: europe-central2
            credentials: ${{ secrets.SA_CREDENTIALS }}
            source_path: ./

        # - name: Deploy function 
        #   working-directory: ./scripts
        #   run: |
        #     chmod 777 ../source_code.zip
        #     python3 main.py "${{env.reponame}}-${{ env.tag }}"
        